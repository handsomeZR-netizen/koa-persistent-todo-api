# 设计文档

## 概述

Todo List API 服务是一个基于 Koa 框架的 RESTful API 服务，提供待办任务的增删改查功能。系统采用文件系统作为持久化存储方案，将所有待办任务数据保存在 `todos.json` 文件中。

核心技术栈：
- **Koa**: 轻量级 Node.js Web 框架
- **koa-router**: 路由中间件
- **koa-bodyparser**: JSON 请求体解析中间件
- **Node.js fs 模块**: 文件系统操作

## 架构

系统采用分层架构设计：

```
┌─────────────────────────────────────┐
│      HTTP 请求/响应层                │
│   (Koa + 中间件)                     │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         路由层                       │
│   (koa-router)                      │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│       业务逻辑层                     │
│   (路由处理器)                       │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      数据访问层                      │
│   (文件系统操作)                     │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      持久化存储                      │
│   (todos.json)                      │
└─────────────────────────────────────┘
```

### 中间件栈

1. **koa-bodyparser**: 解析 JSON 请求体
2. **koa-router**: 路由匹配和处理
3. **错误处理中间件**: 捕获和处理异常

## 组件和接口

### 1. 应用入口 (app.js)

负责初始化 Koa 应用、注册中间件、启动服务器。

```javascript
const Koa = require('koa');
const bodyParser = require('koa-bodyparser');
const router = require('./routes');

const app = new Koa();
const PORT = 3000;

// 中间件
app.use(bodyParser());
app.use(router.routes());
app.use(router.allowedMethods());

app.listen(PORT);
```

### 2. 路由模块 (routes.js)

定义所有 API 端点和对应的处理器。

**接口定义：**

- `GET /api/todos` - 获取所有待办任务
- `POST /api/todos` - 创建新待办任务
- `POST /api/todos/:id` - 更新指定待办任务
- `DELETE /api/todos/:id` - 删除指定待办任务

### 3. 存储模块 (storage.js)

封装文件系统操作，提供数据持久化功能。

**接口：**

```javascript
// 读取所有待办任务
async function loadTodos(): Promise<Todo[]>

// 保存所有待办任务
async function saveTodos(todos: Todo[]): Promise<void>
```

## 数据模型

### Todo 对象结构

```javascript
{
  id: string,          // 唯一标识符 (UUID)
  title: string,       // 任务标题
  completed: boolean,  // 完成状态
  createdAt: string    // 创建时间 (ISO 8601 格式)
}
```

### 存储文件格式

`todos.json` 文件存储一个 Todo 对象数组：

```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "title": "学习 Koa 框架",
    "completed": false,
    "createdAt": "2024-12-02T10:30:00.000Z"
  }
]
```


## 正确性属性

*属性是指在系统的所有有效执行中都应该成立的特征或行为——本质上是关于系统应该做什么的形式化陈述。属性充当人类可读规范和机器可验证正确性保证之间的桥梁。*

### 属性 1：获取所有任务返回完整列表

*对于任何*待办任务列表，当调用 GET `/api/todos` 时，返回的 JSON 数组应该包含存储中的所有任务，且响应状态码为 200
**验证需求：1.1, 1.3, 1.4**

### 属性 2：创建任务生成必需字段

*对于任何*有效的任务标题，当创建新任务时，返回的任务对象应该包含唯一的 id 和 createdAt 时间戳
**验证需求：2.1**

### 属性 3：创建任务保留 completed 状态

*对于任何*提供的 completed 值（true 或 false），创建任务时应该保留该值
**验证需求：2.2**

### 属性 4：创建任务的持久化往返

*对于任何*创建的任务，立即从 JSON 存储文件读取应该能获取到相同的任务数据
**验证需求：2.4**

### 属性 5：成功创建返回 201 和任务对象

*对于任何*有效的创建请求，响应状态码应该为 201，且响应体应该包含创建的任务对象
**验证需求：2.5**

### 属性 6：更新任务修改指定字段

*对于任何*现有任务和有效的更新数据，更新操作应该修改指定的字段
**验证需求：3.1, 3.4**

### 属性 7：更新任务的持久化往返

*对于任何*更新的任务，立即从 JSON 存储文件读取应该能获取到更新后的数据
**验证需求：3.2**

### 属性 8：更新不存在的任务返回 404

*对于任何*不存在的任务 ID，更新请求应该返回 HTTP 状态码 404
**验证需求：3.3**

### 属性 9：部分更新保留未修改字段

*对于任何*现有任务，当只更新部分字段时，未提供的字段应该保持原值不变
**验证需求：3.5**

### 属性 10：删除任务移除存储

*对于任何*现有任务，删除操作后该任务不应该再出现在任务列表中
**验证需求：4.1**

### 属性 11：删除任务的持久化往返

*对于任何*删除的任务，立即从 JSON 存储文件读取应该确认该任务已被移除
**验证需求：4.2**

### 属性 12：删除不存在的任务返回 404

*对于任何*不存在的任务 ID，删除请求应该返回 HTTP 状态码 404
**验证需求：4.3**

### 属性 13：成功删除返回 204

*对于任何*现有任务，成功删除应该返回 HTTP 状态码 204，且响应体为空
**验证需求：4.4**

### 属性 14：服务重启后数据持久化

*对于任何*保存到文件的任务列表，服务重启后加载的任务列表应该与保存前完全一致
**验证需求：5.1**

### 属性 15：JSON 请求体解析

*对于任何*有效的 JSON 请求体，中间件应该正确解析并使路由处理器能够访问解析后的数据
**验证需求：6.1**

### 属性 16：缺少必需字段被拒绝

*对于任何*不包含 title 字段的创建请求，系统应该拒绝该请求并返回错误响应
**验证需求：6.3**

## 错误处理

### 1. 文件系统错误

- **文件不存在**：首次启动时创建空的 `todos.json` 文件
- **文件损坏**：捕获 JSON 解析错误，初始化为空数组，记录警告日志
- **权限错误**：捕获并返回 500 错误，记录详细错误信息

### 2. 请求验证错误

- **缺少必需字段**：返回 400 Bad Request，包含错误详情
- **无效 JSON**：koa-bodyparser 自动处理，返回 400
- **无效数据类型**：验证并返回 400，说明期望的数据类型

### 3. 资源不存在错误

- **任务 ID 不存在**：更新或删除操作返回 404 Not Found

### 4. 服务器错误

- **未预期的异常**：全局错误处理中间件捕获，返回 500，记录错误堆栈

### 错误响应格式

```json
{
  "error": {
    "message": "错误描述",
    "code": "ERROR_CODE"
  }
}
```

## 测试策略

### 单元测试

使用 **Jest** 作为测试框架，测试覆盖：

1. **存储模块测试**
   - 测试文件读写操作
   - 测试文件不存在时的初始化
   - 测试 JSON 解析错误处理

2. **路由处理器测试**
   - 测试每个端点的基本功能
   - 测试边界情况（空列表、不存在的 ID）
   - 测试错误响应

### 基于属性的测试

使用 **fast-check** 库进行基于属性的测试：

- 每个属性测试至少运行 **100 次迭代**
- 每个测试必须使用注释标记对应的设计文档属性：`**Feature: todo-list-api, Property {number}: {property_text}**`
- 每个正确性属性必须由一个单独的基于属性的测试实现

**测试覆盖的属性：**

1. 属性 1-16：使用随机生成的任务数据测试所有 CRUD 操作
2. 往返属性：测试创建-读取、更新-读取、删除-验证的往返一致性
3. 不变性属性：测试部分更新不影响未修改字段
4. 错误条件：测试无效输入和不存在资源的错误处理

### 集成测试

使用 **supertest** 进行 HTTP 端点测试：

1. 测试完整的请求-响应周期
2. 测试中间件栈的正确执行
3. 测试实际的文件系统持久化

### 测试数据生成

为基于属性的测试创建生成器：

```javascript
// 生成随机任务标题
fc.string({ minLength: 1, maxLength: 100 })

// 生成随机 completed 状态
fc.boolean()

// 生成随机任务对象
fc.record({
  title: fc.string({ minLength: 1 }),
  completed: fc.boolean()
})
```

## 实现注意事项

### 1. ID 生成

使用 `uuid` 库生成唯一标识符：

```javascript
const { v4: uuidv4 } = require('uuid');
const id = uuidv4();
```

### 2. 时间戳格式

使用 ISO 8601 格式：

```javascript
const createdAt = new Date().toISOString();
```

### 3. 文件操作

使用 `fs.promises` 进行异步文件操作：

```javascript
const fs = require('fs').promises;

// 读取
const data = await fs.readFile('todos.json', 'utf-8');

// 写入
await fs.writeFile('todos.json', JSON.stringify(todos, null, 2));
```

### 4. 并发安全

当前设计使用简单的文件读写，不处理并发写入。对于生产环境，应考虑：
- 使用文件锁机制
- 或迁移到数据库解决方案

### 5. 输入验证

在路由处理器中验证请求数据：

```javascript
if (!ctx.request.body.title || typeof ctx.request.body.title !== 'string') {
  ctx.status = 400;
  ctx.body = { error: { message: 'title 字段是必需的且必须是字符串' } };
  return;
}
```

## 项目结构

```
todo-list-api/
├── app.js              # 应用入口
├── routes.js           # 路由定义
├── storage.js          # 存储模块
├── package.json        # 项目配置
├── todos.json          # 数据文件（运行时生成）
└── tests/              # 测试目录
    ├── routes.test.js      # 路由测试
    ├── storage.test.js     # 存储测试
    └── properties.test.js  # 基于属性的测试
```

## 依赖项

```json
{
  "dependencies": {
    "koa": "^2.14.0",
    "koa-router": "^12.0.0",
    "koa-bodyparser": "^4.4.0",
    "uuid": "^9.0.0"
  },
  "devDependencies": {
    "jest": "^29.0.0",
    "supertest": "^6.3.0",
    "fast-check": "^3.0.0"
  }
}
```
